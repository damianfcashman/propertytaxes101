<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Help Me Understand My Property Tax Closing Costs</title>
<style>
  /* (Claude‚Äôs original CSS stays unchanged for design) */
  /* --- Paste Claude's full CSS here (unchanged) --- */
</style>
</head>
<body>
<div class="container">
  <div class="title-section">
    <div class="title-text">
      Help Me Understand <br />
      My Property Tax Closing Costs
    </div>
    <img src="data:image/jpeg;base64,..." alt="Profile Picture" 
         onerror="this.src='https://via.placeholder.com/120x120/667eea/ffffff?text=üë§'" />
  </div>

  <div class="input-grid">
    <div class="input-group">
      <label>üè† Property Address</label>
      <input type="text" id="address" placeholder="123 Main Street, Hartford, CT" />
    </div>
    <div class="input-group">
      <label>üìÖ Closing Date</label>
      <input type="date" id="closingDate" />
    </div>
    <div class="input-group">
      <label>üí∞ Annual Property Taxes ($)</label>
      <input type="number" id="annualTax" placeholder="8500" min="0" step="100" />
    </div>
  </div>

  <div id="timeline" class="timeline"></div>

  <div class="info-box">
    <strong>üè† Property Taxes to the Seller:</strong> When you buy a home, the seller may have already paid property taxes in advance. At closing, you'll reimburse them for your share of the taxes they've already paid for the period you'll own the home.
  </div>
  
  <div class="info-box">
    <strong>üè¶ Property Taxes to the Lender's Escrow Account:</strong> In Connecticut, property taxes are due every 6 months (January 1 and July 1). Your lender collects money in advance and holds it in an escrow account to ensure there are enough funds to pay the next tax bill when it comes due.
  </div>
  
  <div class="info-box" id="lenderCalcInfo"></div>

  <div class="results-grid" id="resultsGrid">
    <div class="result"><div class="result-label">Monthly Tax Amount</div><div class="result-value" id="monthlyTax">$0</div></div>
    <div class="result highlight"><div class="result-label">Property Tax You Owe to Seller</div><div class="result-value" id="sellerCredit">$0</div></div>
    <div class="result"><div class="result-label">Tax Bill Paid at Closing</div><div class="result-value" id="taxBillPaid">$0</div></div>
    <div class="result"><div class="result-label">Months Collected in Escrow</div><div class="result-value" id="escrowMonths">0</div></div>
    <div class="result highlight"><div class="result-label">Total Escrow Collected</div><div class="result-value" id="totalEscrow">$0</div></div>
    <div class="result"><div class="result-label">First Mortgage Payment</div><div class="result-value" id="firstPayment">N/A</div></div>
  </div>

  <div class="summary-box">
    <h3>Total Property Tax Costs at Closing</h3>
    <div class="summary-amount" id="totalClosingTax">$0</div>
  </div>
</div>

<script>
const allMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const monthlyTaxSpan = document.getElementById('monthlyTax');
const sellerCreditSpan = document.getElementById('sellerCredit');
const taxBillPaidSpan = document.getElementById('taxBillPaid');
const escrowMonthsSpan = document.getElementById('escrowMonths');
const totalEscrowSpan = document.getElementById('totalEscrow');
const firstPaymentSpan = document.getElementById('firstPayment');
const totalClosingTaxSpan = document.getElementById('totalClosingTax');
const lenderCalcInfo = document.getElementById('lenderCalcInfo');
const timelineDiv = document.getElementById('timeline');

function formatCurrency(amount) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0
  }).format(amount);
}

function calculateAndRender() {
  const annualTax = parseFloat(document.getElementById('annualTax').value) || 0;
  const closingDateInput = document.getElementById('closingDate').value;
  if (!annualTax || !closingDateInput) return;

  const monthlyTax = annualTax / 12;
  monthlyTaxSpan.textContent = formatCurrency(monthlyTax);

  const closingDate = new Date(closingDateInput);
  const closingMonth = closingDate.getMonth();
  const closingYear = closingDate.getFullYear();
  const halfYearTax = annualTax / 2;

  const currentPeriodStart = (closingMonth >= 6) ? new Date(closingYear, 6, 1) : new Date(closingYear, 0, 1);
  const currentPeriodEnd = (closingMonth >= 6) ? new Date(closingYear + 1, 0, 1) : new Date(closingYear, 6, 1);

  const msPerDay = 1000*60*60*24;
  const totalDays = Math.ceil((currentPeriodEnd - currentPeriodStart) / msPerDay);
  const daysRemaining = Math.ceil((currentPeriodEnd - closingDate) / msPerDay);
  const sellerCredit = (halfYearTax / totalDays) * daysRemaining;
  sellerCreditSpan.textContent = formatCurrency(sellerCredit);

  const nextBillDate = (closingMonth >= 6) ? new Date(closingYear + 1, 0, 1) : new Date(closingYear, 6, 1);
  const nextBillMonth = nextBillDate.getMonth();
  const daysToNextBill = Math.ceil((nextBillDate - closingDate) / msPerDay);

  // Escrow calculation with buffer
  let taxBillPaid = 0, escrowMonths = 0;
  if (daysToNextBill <= 60) {
    taxBillPaid = halfYearTax;
    escrowMonths = 2; // 1 short month + 1 buffer
  } else {
    const monthsShort = (closingMonth >= 6) ? (12 - (closingMonth + 1)) : (6 - (closingMonth + 1));
    escrowMonths = monthsShort + 1;
  }

  taxBillPaidSpan.textContent = formatCurrency(taxBillPaid);
  escrowMonthsSpan.textContent = escrowMonths;
  const totalEscrowAmount = monthlyTax * escrowMonths;
  totalEscrowSpan.textContent = formatCurrency(totalEscrowAmount);

  const totalClosingCosts = sellerCredit + taxBillPaid + totalEscrowAmount;
  totalClosingTaxSpan.textContent = formatCurrency(totalClosingCosts);

  const firstPaymentMonth = (closingMonth + 2) % 12;
  const firstPaymentYear = closingYear + Math.floor((closingMonth + 2) / 12);
  const firstPaymentDate = new Date(firstPaymentYear, firstPaymentMonth, 1);
  firstPaymentSpan.textContent = `${allMonths[firstPaymentMonth]} ${firstPaymentYear}`;

  lenderCalcInfo.innerHTML = 
    `<strong>üßÆ How Lenders Calculate:</strong> You'll reimburse the seller ${formatCurrency(sellerCredit)} for prepaid taxes. ` +
    `${taxBillPaid > 0 ? `Tax bill due soon, ${formatCurrency(taxBillPaid)} is paid at closing.` : ''} ` +
    `Lender collects ${escrowMonths} month(s) (${formatCurrency(totalEscrowAmount)}) including a 1-month buffer.` +
    ` First mortgage payment is ${allMonths[firstPaymentMonth]} ${firstPaymentYear}.`;

  renderTimeline(closingMonth, firstPaymentDate, nextBillMonth);
}

function renderTimeline(closingMonth, firstPaymentDate, nextBillMonth) {
  timelineDiv.innerHTML = '';
  const monthsToShow = [];
  let current = closingMonth;
  while (true) {
    monthsToShow.push(current);
    if (current === nextBillMonth) break;
    current = (current + 1) % 12;
  }
  for (let i = 1; i <= 6; i++) {
    monthsToShow.push((nextBillMonth + i) % 12);
  }

  monthsToShow.forEach((monthIdx, index) => {
    const box = document.createElement('div');
    box.classList.add('month-box');

    if (monthIdx >= 6) box.classList.add('shaded');
    let label = '', tooltip = '';

    if (monthIdx === closingMonth) {
      box.classList.add('closing');
      label = "üè†<br><span class='month-label'>Closing Month</span>";
      tooltip = "Your closing happens this month";
    } else if (index < monthsToShow.indexOf(nextBillMonth)) {
      label = "üí∞";
      tooltip = "Taxes prepaid by seller for this month";
    }
    if (monthIdx === 0 || monthIdx === 6) {
      box.classList.add('tax-due');
      label = "üßæ<br><span class='month-label'>Next Tax Period</span>";
      tooltip = "Property tax bill due this month";
    }
    if (monthIdx === firstPaymentDate.getMonth()) {
      box.classList.add('first-payment');
      if (!label.includes('üè†') && !label.includes('üßæ')) {
        label = "üí≥<br><span class='month-label'>First Payment</span>";
        tooltip = "First mortgage payment due";
      }
    }

    box.innerHTML = `${allMonths[monthIdx]}<br>${label}${tooltip ? `<div class='tooltip'>${tooltip}</div>` : ''}`;
    timelineDiv.appendChild(box);

    if (index < monthsToShow.length - 1) {
      const arrow = document.createElement('div');
      arrow.classList.add('arrow');
      arrow.textContent = "‚Üí";
      timelineDiv.appendChild(arrow);
    }
  });
}

document.getElementById('annualTax').addEventListener('input', calculateAndRender);
document.getElementById('closingDate').addEventListener('change', calculateAndRender);
</script>
</body>
</html>
