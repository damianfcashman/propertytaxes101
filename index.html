<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Help Me Understand My Property Tax Closing Costs</title>
<style>
  body { font-family: Arial, sans-serif; background-color: #f9f9f9; margin: 20px; }
  .container { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); max-width: 950px; margin: auto; }
  .title-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .title-text { font-size: 26px; font-weight: bold; line-height: 1.2; }
  .title-section img { width: 120px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2); }
  label { display: block; margin-top: 10px; }
  input { width: 220px; padding: 6px; margin-left: 10px; }
  .timeline { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
  .month-container { display: flex; align-items: center; }
  .arrow { margin: 0 5px; font-size: 18px; color: #888; }
  .month-box { border: 1px solid #ccc; background: #fff; padding: 10px; margin: 5px; border-radius: 5px; min-width: 75px; text-align: center; position: relative; }
  .shaded { background-color: #fff7f0; }
  .closing { font-weight: bold; border: 2px solid #2a7ae4; background-color: #e6f0ff; }
  .month-label { font-size: 10px; font-style: italic; margin-top: 3px; display: block; }
  .first-payment { background-color: #e6ffe6; }
  .tax-due { background-color: #ffe6e6; }
  .tooltip { position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 3px 6px; border-radius: 4px; font-size: 11px; display: none; white-space: nowrap; }
  .month-box:hover .tooltip { display: block; }
  .info-box { background: #eaf4ff; border-left: 4px solid #2a7ae4; padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 14px; text-align: left; }
  .result { font-weight: bold; margin-top: 10px; }
</style>
</head>
<body>
<div class="container">
  <div class="title-section">
    <div class="title-text">
      Help Me Understand <br />
      My Property Tax Closing Costs
    </div>
    <img src="images/headshot.jpg" alt="Profile Picture" />
  </div>

  <label>Property Address: <input type="text" id="address" /></label>
  <label>Closing Date: <input type="date" id="closingDate" /></label>
  <label>Annual Property Taxes ($): <input type="number" id="annualTax" /></label>

  <div id="timeline" class="timeline"></div>

  <div class="info-box">
    <strong>üè† Property Taxes to the Seller:</strong> When you buy a home, the seller may have already paid property taxes in advance. At closing, you‚Äôll reimburse them for your share.
  </div>
  <div class="info-box">
    <strong>üè¶ Property Taxes to the Lender‚Äôs Escrow Account:</strong> In Connecticut, property taxes are due every 6 months (January 1 and July 1). Your lender ensures enough funds in escrow to pay the next bill.
  </div>
  <div class="info-box" id="lenderCalcInfo"></div>

  <div class="result">Monthly Tax Amount: <span id="monthlyTax">0</span></div>
  <div class="result">Property Tax You Owe to Seller: <span id="sellerCredit">0</span></div>
  <div class="result">Tax Bill Paid at Closing: <span id="taxBillPaid">0</span></div>
  <div class="result">Months Collected in Escrow: <span id="escrowMonths">0</span></div>
  <div class="result">Total Escrow Collected: <span id="totalEscrow">0</span></div>
  <div class="result">First Mortgage Payment: <span id="firstPayment">N/A</span></div>
</div>

<script>
const monthlyTaxSpan = document.getElementById('monthlyTax');
const sellerCreditSpan = document.getElementById('sellerCredit');
const taxBillPaidSpan = document.getElementById('taxBillPaid');
const escrowMonthsSpan = document.getElementById('escrowMonths');
const totalEscrowSpan = document.getElementById('totalEscrow');
const firstPaymentSpan = document.getElementById('firstPayment');
const lenderCalcInfo = document.getElementById('lenderCalcInfo');
const timelineDiv = document.getElementById('timeline');
const allMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function calculateAndRender() {
  const annualTax = parseFloat(document.getElementById('annualTax').value) || 0;
  const monthlyTax = annualTax / 12;
  monthlyTaxSpan.textContent = monthlyTax.toFixed(2);

  const closingDate = new Date(document.getElementById('closingDate').value);
  if (isNaN(closingDate)) return;

  const closingMonth = closingDate.getMonth();
  const closingYear = closingDate.getFullYear();
  const halfYearTax = annualTax / 2;

  const currentPeriodStart = (closingMonth >= 6) ? new Date(closingYear, 6, 1) : new Date(closingYear, 0, 1);
  const currentPeriodEnd = (closingMonth >= 6) ? new Date(closingYear + 1, 0, 1) : new Date(closingYear, 6, 1);

  const msPerDay = 1000 * 60 * 60 * 24;
  const totalDays = Math.ceil((currentPeriodEnd - currentPeriodStart) / msPerDay);
  const daysRemaining = Math.ceil((currentPeriodEnd - closingDate) / msPerDay);
  const sellerCredit = (halfYearTax / totalDays) * daysRemaining;
  sellerCreditSpan.textContent = sellerCredit.toFixed(2);

  const nextBillDate = (closingMonth >= 6) ? new Date(closingYear + 1, 0, 1) : new Date(closingYear, 6, 1);
  const daysToNextBill = Math.ceil((nextBillDate - closingDate) / msPerDay);

  let taxBillPaid = 0;
  let escrowMonths = 0;

  if (daysToNextBill <= 60) {
    taxBillPaid = halfYearTax;
    escrowMonths = 2;
  } else {
    taxBillPaid = 0;
    escrowMonths = 4;
  }

  taxBillPaidSpan.textContent = taxBillPaid.toFixed(2);
  escrowMonthsSpan.textContent = escrowMonths;
  totalEscrowSpan.textContent = (monthlyTax * escrowMonths).toFixed(2);

  // ‚úÖ Corrected first mortgage payment calculation
  let firstPaymentMonth = (closingMonth + 2) % 12;
  let firstPaymentYear = closingYear + Math.floor((closingMonth + 2) / 12);
  let firstPaymentDate = new Date(firstPaymentYear, firstPaymentMonth, 1);
  firstPaymentSpan.textContent = `${allMonths[firstPaymentDate.getMonth()]} ${firstPaymentDate.getFullYear()}`;

  lenderCalcInfo.textContent =
    `üè¶ How Lenders Calculate: At closing, seller credit covers taxes they prepaid. If a tax bill is due within 60 days, ` +
    `the settlement agent collects and mails a full 6-month payment to the city. The lender also collects ${escrowMonths} months ` +
    `of escrow so funds are ready for the following tax cycle.`;

  renderTimeline(closingDate, firstPaymentDate, nextBillDate, taxBillPaid);
}

function renderTimeline(closingDate, firstPaymentDate, nextBillDate, taxBillPaid) {
  timelineDiv.innerHTML = '';
  const closingMonth = closingDate.getMonth();
  const nextBillMonth = nextBillDate.getMonth();

  let monthsToShow = [];
  let current = closingMonth;
  while (true) {
    monthsToShow.push(current);
    if (current === nextBillMonth) break;
    current = (current + 1) % 12;
  }
  for (let i = 1; i <= 6; i++) {
    monthsToShow.push((nextBillMonth + i) % 12);
  }

  monthsToShow.forEach((monthIdx, index) => {
    const container = document.createElement("div");
    container.classList.add("month-container");

    const monthBox = document.createElement("div");
    monthBox.classList.add("month-box");

    if (monthIdx >= 6) monthBox.classList.add("shaded");

    let label = '';
    if (monthIdx === closingMonth) {
      monthBox.classList.add("closing");
      label = "üè†<br><span class='month-label'>Current Tax Period</span>";
    }
    if (monthIdx !== closingMonth && monthIdx !== nextBillMonth) {
      label = "üí∞<div class='tooltip'>Taxes paid by seller, reimbursed at closing</div>";
    }
    if (monthIdx === nextBillMonth) {
      monthBox.classList.add("tax-due");
      label = "üßæ<br><span class='month-label'>Next Tax Period</span>";
    }
    if (monthIdx === firstPaymentDate.getMonth()) {
      monthBox.classList.add("first-payment");
    }

    monthBox.innerHTML = `${allMonths[monthIdx]}<br>${label}`;
    container.appendChild(monthBox);

    if (index < monthsToShow.length - 1) {
      const arrow = document.createElement("div");
      arrow.classList.add("arrow");
      arrow.textContent = "‚Üí";
      container.appendChild(arrow);
    }
    timelineDiv.appendChild(container);
  });
}

document.getElementById('annualTax').addEventListener('input', calculateAndRender);
document.getElementById('closingDate').addEventListener('change', calculateAndRender);
</script>
</body>
</html>
