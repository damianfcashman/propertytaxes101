<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Help me understand my tax closing costs</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 20px;
    }
    .container {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      max-width: 900px;
      margin: auto;
      text-align: center;
    }
    label {
      display: block;
      margin-top: 10px;
      text-align: left;
    }
    input {
      width: 200px;
      padding: 5px;
      margin-left: 10px;
    }
    .result {
      font-weight: bold;
      margin-top: 20px;
    }
    .timeline {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 20px;
    }
    .month-container {
      display: flex;
      align-items: center;
      position: relative;
    }
    .arrow {
      margin: 0 5px;
      font-size: 18px;
      color: #888;
    }
    .month-box {
      border: 1px solid #ccc;
      background: #fff;
      padding: 10px;
      margin: 5px;
      border-radius: 5px;
      min-width: 70px;
      min-height: 60px;
      position: relative;
      text-align: center;
      transition: transform 0.3s;
    }
    .month-label {
      font-size: 10px;
      font-style: italic;
      margin-top: 3px;
    }
    .closing {
      animation: pulse 2s infinite;
      font-weight: bold;
    }
    .first-payment {
      background-color: #e6ffe6;
      animation: bounce 1.5s infinite;
    }
    .tax-due {
      background-color: #ffe6e6;
      font-weight: bold;
    }
    .seller-owed::after {
      content: "üí∞";
      position: absolute;
      bottom: 5px;
      right: 5px;
      font-size: 14px;
    }
    .legend {
      margin-top: 20px;
      background: #f8f8f8;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
      display: inline-block;
      text-align: left;
    }
    .legend-item { margin: 5px 0; }

    /* Animations */
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 0, 255, 0.6); }
      70% { box-shadow: 0 0 10px 10px rgba(0, 0, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 0, 255, 0); }
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Help me understand my tax closing costs</h2>
    
    <label>Property Address: <input type="text" id="address" /></label>
    <label>Closing Date: <input type="date" id="closingDate" /></label>
    <label>Annual Property Tax ($): <input type="number" id="annualTax" /></label>
    
    <div class="result">Monthly Tax Amount: <span id="monthlyTax">0</span></div>
    <div class="result">Months Needed Upfront: <span id="monthsUpfront">0</span></div>
    <div class="result">Property Tax You Owe to Seller: <span id="sellerCredit">0</span></div>
    <div class="result">Total Escrow Collected: <span id="totalEscrow">0</span></div>
    
    <div id="timeline" class="timeline"></div>

    <div class="legend">
      <div class="legend-item">üè† <strong>Closing Month</strong></div>
      <div class="legend-item">üí∞ <strong>Seller Owed</strong> - Months seller prepaid taxes</div>
      <div class="legend-item">‚úÖ <strong>First Payment</strong></div>
      <div class="legend-item">üßæ <strong>Tax Bill Due</strong></div>
      <div class="legend-item"><em>Current Tax Period</em> and <em>Next Tax Period</em> labels show tax cycle boundaries</div>
    </div>
  </div>

  <script>
    const annualTaxInput = document.getElementById('annualTax');
    const closingDateInput = document.getElementById('closingDate');
    const monthlyTaxSpan = document.getElementById('monthlyTax');
    const monthsUpfrontSpan = document.getElementById('monthsUpfront');
    const sellerCreditSpan = document.getElementById('sellerCredit');
    const totalEscrowSpan = document.getElementById('totalEscrow');
    const timelineDiv = document.getElementById('timeline');

    const allMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    function calculateEscrow() {
      const annualTax = parseFloat(annualTaxInput.value) || 0;
      const monthlyTax = annualTax / 12;
      monthlyTaxSpan.textContent = monthlyTax.toFixed(2);

      const closingDate = new Date(closingDateInput.value);
      if (isNaN(closingDate)) return;

      const closingMonth = closingDate.getMonth();
      const closingYear = closingDate.getFullYear();

      let nextTaxDueMonth;
      if (closingMonth >= 6) {
        nextTaxDueMonth = 0; // Jan
      } else {
        nextTaxDueMonth = 6; // Jul
      }

      const monthsToShow = [];
      let m = closingMonth;
      while (true) {
        monthsToShow.push(m);
        if ((closingMonth >= 6 && m === 11) || (closingMonth < 6 && m === 5)) break;
        m = (m + 1) % 12;
      }
      for (let i = 0; i < 6; i++) {
        monthsToShow.push((nextTaxDueMonth + i) % 12);
      }

      const monthsNeededUpfront = (monthsToShow.length > 6) ? monthsToShow.length - 6 : monthsToShow.length;
      monthsUpfrontSpan.textContent = monthsNeededUpfront;

      const halfYearTax = annualTax / 2;
      const periodStart = (closingMonth >= 6) ? new Date(closingYear, 6, 1) : new Date(closingYear, 0, 1);
      const periodEnd = (closingMonth >= 6) ? new Date(closingYear + 1, 0, 1) : new Date(closingYear, 6, 1);

      const msPerDay = 1000 * 60 * 60 * 24;
      const totalDaysInPeriod = Math.ceil((periodEnd - periodStart) / msPerDay);
      const daysRemaining = Math.ceil((periodEnd - closingDate) / msPerDay);
      const sellerCredit = (halfYearTax / totalDaysInPeriod) * daysRemaining;
      sellerCreditSpan.textContent = sellerCredit.toFixed(2);

      const totalCollectedAdjusted = monthlyTax * monthsNeededUpfront;
      totalEscrowSpan.textContent = totalCollectedAdjusted.toFixed(2);

      const firstPaymentDate = new Date(closingDate);
      firstPaymentDate.setMonth(firstPaymentDate.getMonth() + 2);
      firstPaymentDate.setDate(1);

      renderTimeline(closingDate, firstPaymentDate, nextTaxDueMonth, monthsToShow);
    }

    function renderTimeline(closingDate, firstPaymentDate, nextTaxDueMonth, monthsToShow) {
      timelineDiv.innerHTML = "";
      const closingMonth = closingDate.getMonth();
      const firstNextTaxIndex = monthsToShow.indexOf(nextTaxDueMonth);

      monthsToShow.forEach((mIndex, index) => {
        const container = document.createElement("div");
        container.classList.add("month-container");

        const monthBox = document.createElement("div");
        monthBox.classList.add("month-box");
        monthBox.textContent = allMonths[mIndex];

        if (mIndex === closingMonth) {
          monthBox.classList.add("closing");
          monthBox.textContent += " üè†";
        }

        if (mIndex === firstPaymentDate.getMonth()) {
          monthBox.classList.add("first-payment");
          monthBox.textContent += " ‚úÖ";
        }

        if (mIndex === nextTaxDueMonth) {
          monthBox.classList.add("tax-due");
          monthBox.textContent += " üßæ";
        }

        if ((closingMonth >= 6 && mIndex >= closingMonth && mIndex <= 11) ||
            (closingMonth < 6 && mIndex >= closingMonth && mIndex <= 5)) {
          monthBox.classList.add("seller-owed");
        }

        // Labels
        if (index === 0) {
          const label = document.createElement("div");
          label.classList.add("month-label");
          label.textContent = "Current Tax Period";
          monthBox.appendChild(label);
        }
        if (index === firstNextTaxIndex) {
          const label = document.createElement("div");
          label.classList.add("month-label");
          label.textContent = "Next Tax Period";
          monthBox.appendChild(label);
        }

        container.appendChild(monthBox);

        // Add arrow unless it's the last box
        if (index < monthsToShow.length - 1) {
          const arrow = document.createElement("div");
          arrow.classList.add("arrow");
          arrow.textContent = "‚Üí";
          container.appendChild(arrow);
        }

        timelineDiv.appendChild(container);
      });
    }

    annualTaxInput.addEventListener('input', calculateEscrow);
    closingDateInput.addEventListener('change', calculateEscrow);
  </script>
</body>
</html>
